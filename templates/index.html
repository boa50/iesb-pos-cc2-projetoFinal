<!-- ReferÃªncias
  https://developers.google.com/web/fundamentals/media/recording-audio
  https://stackoverflow.com/questions/32288722/call-python-function-from-js
  https://flask.palletsprojects.com/en/1.1.x/patterns/jquery/
-->

<!doctype html>
<html>
<head>
<title>Hello from Flask</title>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
</head>
<body>
<h1>Hello, World!</h1>
<a id="download">Download</a>
<button id="stop">Stop</button>
<audio id="player" controls></audio>
<script>
  let shouldStop = false;
  let stopped = false;
  const downloadLink = document.getElementById('download');
  const stopButton = document.getElementById('stop');

  stopButton.addEventListener('click', function() {
    shouldStop = true;
  });

  function callbackFunc(response) {
    // do something with the response
    console.log(response);
}

  function callJumentoBranco(blob) {
    $.ajax({
          type: "POST",
          url: "/jumento",
          data: blob,
    processData: false,
    contentType: false,
          success: callbackFunc
      });
  }


  const handleSuccess = function(stream) {
    const options = {mimeType: 'audio/webm'};
    const recordedChunks = [];
    const mediaRecorder = new MediaRecorder(stream, options);

    mediaRecorder.ondataavailable = function(e) {
      if (e.data.size > 0) {
        recordedChunks.push(e.data);
      }

      if(shouldStop === true && stopped === false) {
        mediaRecorder.stop();
        stopped = true;
      }
    };

    mediaRecorder.onstop = function() {
      callJumentoBranco(new Blob(recordedChunks));
      if (window.URL) {
      player.srcObject = stream;
    } else {
      player.src = stream;
    }

      downloadLink.href = URL.createObjectURL(new Blob(recordedChunks));
      downloadLink.download = 'acetest.wav';
    };

    mediaRecorder.start(1000);
  };

  navigator.mediaDevices.getUserMedia({ audio: true, video: false })
      .then(handleSuccess);

</script>
</body>
</html>