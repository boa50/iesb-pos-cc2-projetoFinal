<!-- Referências
  https://developers.google.com/web/fundamentals/media/recording-audio
  https://stackoverflow.com/questions/32288722/call-python-function-from-js
  https://flask.palletsprojects.com/en/1.1.x/patterns/jquery/
-->

<!doctype html>
<html>
  <head>
    <title>Tradutor de Frases</title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  </head>
  <body>
    <h1>Tradutor de Frases</h1>

    <label for="idiomas">Escolha um idioma:</label>
    <select id="idiomas">
      <option value="pt-br" selected>Português</option>
      <option value="en">Inglês</option>
      <option value="ja">Japonês</option>
      <option value="es">Espanhol</option>
      <option value="de">Alemão</option>
      <option value="it">Italiano</option>
    </select>

    <br>
    <button id="start">Start</button>
    <button id="stop">Stop</button>
    <br>

    <p>A farse que você disse foi: </p>
    <span id=frase_falada>?</span>

    <p>A tradução da frase é: </p>
    <span id=frase_traduzida>?</span>

    <br>

    <label for="player">Escute a tradução:</label>
    <audio id="player" controls></audio>

    <script>
      let shouldStop = false;
      let stopped = false;
      const startButton = document.getElementById('start');
      const stopButton = document.getElementById('stop');

      startButton.addEventListener('click', function() {
        shouldStop = false;
        stopped = false;
        player.src = '';

        navigator.mediaDevices.getUserMedia({ audio: true, video: false })
          .then(handleSuccess);
      });

      stopButton.addEventListener('click', function() {
        shouldStop = true;
      });

      function callbackFunc(response) {
        $("#frase_falada").text(response.frase);
        $("#frase_traduzida").text(response.traducao);
        player.src = '/static/audio.mp3';
    }

      function enviaInformacoes(blob) {
        let idioma = $("#idiomas").val();

        $.ajax({
              type: "POST",
              url: "/processa/" + idioma,
              data: blob,
              processData: false,
              contentType: false,
              success: callbackFunc
          });
      }

      const handleSuccess = function(stream) {
        const options = {mimeType: 'audio/webm'};
        const recordedChunks = [];
        const mediaRecorder = new MediaRecorder(stream, options);

        mediaRecorder.ondataavailable = function(e) {
          if (e.data.size > 0) {
            recordedChunks.push(e.data);
          }

          if(shouldStop === true && stopped === false) {
            mediaRecorder.stop();
            stopped = true;
          }
        };

        mediaRecorder.onstop = function() {
          enviaInformacoes(new Blob(recordedChunks));
        };

        mediaRecorder.start(1000);

      };

    </script>
  </body>
</html>